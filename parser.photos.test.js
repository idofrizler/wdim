const { JSDOM } = require('jsdom');
const { parseHTMLRows } = require('./content/parser.js');  // add this line

describe("Photos shared on group chats", () => {
    
    // Unknown sender
    it("photo from unknown sender", () => {
      const dom = new JSDOM(`<div class="" role="row"><div tabindex="-1" class="CzM4m" data-id="false_120363026340588079@g.us_63183699AC0C1C4E4CFC0FCC7AE156EF_972584020420@c.us" data-testid="conv-msg-false_120363026340588079@g.us_63183699AC0C1C4E4CFC0FCC7AE156EF_972584020420@c.us"><div class="_3EyT- message-in focusable-list-item _1AOLJ _1jHIY"><span></span><div data-testid="msg-container" class="UzMP7 _27hEJ"><div class="_1BOF7 _2AOIt"><div class="cm280p3y eu4mztcy ocd2b0bc folpon7g aa0kojfi snweb893 g0rxnol2 jnl3jror"><div><div class="bxcbqipq mhcwslh8 ocd2b0bc jfqm35v0"><div class="_3IzYj color-11 _6rIWC p357zi0d" role=""><span data-testid="author" dir="auto" aria-label="Maybe Veronica" class="_2ne0X ggj6brxn gfz4du6o r7fjleex g0rxnol2 lhj4utae le5p0ye3 ajgl1lbb edeob0r2 _11JPr">Veronica</span><span class="WJuYU" testid="author" role="button">+972 58-402-0420</span></div></div><div data-testid="image-thumb" class="gndfcl4n l8fojup5 paxyh2gw sfeitywo cqsf3vkf p357zi0d ac2vgrno laorhtua gfz4du6o r7fjleex g0rxnol2" style="width: 240px; height: 338.028px;" role="button" tabindex="0" aria-label="Open Picture"><div class="g0rxnol2 ln8gz9je ppled2lx" data-testid="media-url-provider"><div class="lhggkp7q jnl3jror p357zi0d gndfcl4n ac2vgrno ln8gz9je ppled2lx"><img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEABsbGxscGx4hIR4qLSgtKj04MzM4PV1CR0JHQl2NWGdYWGdYjX2Xe3N7l33gsJycsOD/2c7Z//////////////8BGxsbGxwbHiEhHiotKC0qPTgzMzg9XUJHQkdCXY1YZ1hYZ1iNfZd7c3uXfeCwnJyw4P/Zztn////////////////CABEIADwAIQMBIgACEQEDEQH/xAAuAAACAwEBAAAAAAAAAAAAAAAAAQIEBQMGAQEBAQAAAAAAAAAAAAAAAAAAAQL/2gAMAwEAAhADEAAAAKcthy5tmyJmGmKNMALEARfNyzIlMQlCeVDOtrt5/om6Ygf/xAAkEAAABgEDBAMAAAAAAAAAAAAAAQIDEBEEFDJSEiAhMUFRYf/aAAgBAQABPwA8V6toRiun7SE4qyLaHGlKQlBfBDRLmpIimu2xc2D8iosWLjWI/RqmvsFks8gTjfMh1o5lFwkxY//EABcRAQEBAQAAAAAAAAAAAAAAABEAEDD/2gAIAQIBAT8AMODN/8QAFxEBAAMAAAAAAAAAAAAAAAAAEQAQMP/aAAgBAwEBPwBpxJ//2Q==" class="jciay5ix tvf2evcx oq44ahr5 lb5m6g5c fsmudgz7" style="width: 100%;"></div><div class="lhggkp7q jnl3jror p357zi0d gndfcl4n ac2vgrno ln8gz9je ppled2lx"><img src="blob:https://web.whatsapp.com/07cc972f-4a95-44a7-be03-2897bb421bf0" class="jciay5ix tvf2evcx oq44ahr5 lb5m6g5c" style="width: 100%;"></div><div class="lhggkp7q jnl3jror p357zi0d gndfcl4n ac2vgrno ln8gz9je ppled2lx"><img src="blob:https://web.whatsapp.com/a4125c45-a647-48e5-88b8-abe62948f691" class="jciay5ix tvf2evcx oq44ahr5 lb5m6g5c" style="width: 100%;"></div><div class="lhggkp7q jnl3jror p357zi0d gndfcl4n ac2vgrno ln8gz9je ppled2lx"><img src="blob:https://web.whatsapp.com/3455462c-d210-45c5-8722-9b6c5155fbcf" class="jciay5ix tvf2evcx oq44ahr5 lb5m6g5c" style="width: 100%;"></div><div class="lhggkp7q jnl3jror p357zi0d gndfcl4n ac2vgrno ln8gz9je ppled2lx"><img src="blob:https://web.whatsapp.com/1e60508d-0d69-4011-b364-e3f06b436395" class="jciay5ix tvf2evcx oq44ahr5 lb5m6g5c" style="width: 100%;"></div></div><div class="lhggkp7q jxacihee tkdu00h0 b9fczbqn ln8gz9je he7yjufn e1lnay39"></div></div><div class="dpkuihx7 lhggkp7q j2mzdvlq b9fczbqn"><div class="pp8r7oc8 o38k74y6 e4p1bexh cr2cog7z le5p0ye3 p357zi0d gndfcl4n" data-testid="msg-meta"><span class="l7jjieqr fewfhwl7" dir="auto">14:40</span></div></div></div></div><span></span><div class="_1OdBf"></div></div><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd p357zi0d dnb887gk gjuq5ydh i2cterl7 fhf7t426 sap93d0t gndfcl4n FxqSn"><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd dnb887gk gjuq5ydh i2cterl7 rqm6ogl5 i5tg98hk folpon7g przvwfww snweb893"><div role="button" tabindex="0" aria-label="Forward media" class="_1Gsa4 p357zi0d gndfcl4n ac2vgrno cxkis295 rqm6ogl5 i5tg98hk f9ovudaz przvwfww gx1rr48f f8jlpxt4 hnx8ox4h k17s6i4e ofejerhi ilbp7ui4 g9p5wyxn i0tg5vk9 aoogvgrq o2zu3hjb a27i2aag rtx6r8la e3b81npk oa9ii99z fb82vjfj"><span data-testid="forward-chat" data-icon="forward-chat" class="r83rrh3w"><svg viewBox="0 0 25 25" height="25" width="25" preserveAspectRatio="xMidYMid meet" class="" version="1.1" x="0px" y="0px" enable-background="new 0 0 25 25" xml:space="preserve"><path fill-rule="evenodd" clip-rule="evenodd" fill="currentColor" d="M14.248,6.973c0-0.614,0.741-0.921,1.174-0.488l5.131,5.136 c0.269,0.269,0.269,0.704,0,0.973l-5.131,5.136c-0.433,0.433-1.174,0.126-1.174-0.488v-2.319c-4.326,0-7.495,1.235-9.85,3.914 c-0.209,0.237-0.596,0.036-0.511-0.268c1.215-4.391,4.181-8.492,10.361-9.376V6.973z"></path></svg></span></div></div><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd dnb887gk gjuq5ydh i2cterl7 rqm6ogl5 i5tg98hk folpon7g przvwfww snweb893"><div></div></div></div></div></div></div></div>`);
      const rowElements = dom.window.document.querySelectorAll('div[role="row"]');
  
      const result = parseHTMLRows(rowElements);
      expect(result).toHaveProperty("messageCount");
      expect(result).toHaveProperty("messageText");
      expect(result.messageText).toBe('[14:40] +972 58-402-0420 (Maybe Veronica) shared a photo<br>');
      expect(result.messageCount).toBe(1);  
    });
  
    // photo with text
    it("photo with text", () => {
      const dom = new JSDOM(`<div class="" role="row"><div tabindex="-1" class="CzM4m" data-id="true_972503235812@c.us_53DE6AAC2F3C843EA50C99D050D083D8" data-testid="conv-msg-true_972503235812@c.us_53DE6AAC2F3C843EA50C99D050D083D8"><div class="_3EyT- message-out focusable-list-item _1AOLJ _2UtSC _1jHIY"><span></span><div data-testid="msg-container" class="UzMP7 _27hEJ _3m5cz"><span data-testid="tail-out" data-icon="tail-out" class="p0s8B"><svg viewBox="0 0 8 13" height="13" width="8" preserveAspectRatio="xMidYMid meet" class="" version="1.1" x="0px" y="0px" enable-background="new 0 0 8 13" xml:space="preserve"><path opacity="0.13" d="M5.188,1H0v11.193l6.467-8.625 C7.526,2.156,6.958,1,5.188,1z"></path><path fill="currentColor" d="M5.188,0H0v11.193l6.467-8.625C7.526,1.156,6.958,0,5.188,0z"></path></svg></span><div class="_1BOF7 _2AOIt"><span aria-label="You:"></span><div class="cm280p3y eu4mztcy ocd2b0bc folpon7g aa0kojfi snweb893 g0rxnol2 jnl3jror copyable-text" data-pre-plain-text="[10:55, 01/08/2023] Ido Frizler: "><div><div data-testid="image-thumb" class="gndfcl4n l8fojup5 paxyh2gw sfeitywo cqsf3vkf p357zi0d ac2vgrno laorhtua gfz4du6o r7fjleex g0rxnol2" style="width: 240px; height: 270.4px;" role="button" tabindex="0" aria-label="Open Picture"><div class="g0rxnol2 ln8gz9je ppled2lx" data-testid="media-url-provider"><div class="lhggkp7q jnl3jror p357zi0d gndfcl4n ac2vgrno ln8gz9je ppled2lx"><img alt="זו" src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEABsbGxscGx4hIR4qLSgtKj04MzM4PV1CR0JHQl2NWGdYWGdYjX2Xe3N7l33gsJycsOD/2c7Z//////////////8BGxsbGxwbHiEhHiotKC0qPTgzMzg9XUJHQkdCXY1YZ1hYZ1iNfZd7c3uXfeCwnJyw4P/Zztn////////////////CABEIAEgAPwMBIgACEQEDEQH/xAAxAAACAwEBAAAAAAAAAAAAAAAEBQACAwEGAQACAwEAAAAAAAAAAAAAAAACAwABBQT/2gAMAwEAAhADEAAAAA26iBzk7V2Hr6tPrCUWMDLOuKxDjKseOB7VK/0KKSnctSz9sbm1eBmRQ6QgrVVF0rXYs7l+YyiDVhQ6mmXVpLK1yKvkXCSE9g2kW+edkuqbyGj/xAAnEAACAgICAQMDBQAAAAAAAAABAgADERIEMSETIkIQFDIjQVFSYf/aAAgBAQABPwBFJZcjxmaJqBLOP7iqifbKAm5MNdb/AB/aW8Z0GfqLCBiNy3RQJwLtkdm8tHsbyM+TK2YAZ8zkag+5pbRXqpQwjBIgBPUv8OBKvXPismJwLXwz2GMvI45HyQTkWm1+iAJXa2s7OZx7FrfLCcwq92y9TghAmTFYY8ES1k6JE5gVWIEQEKIIQoUfzLK9hKKS1Qx3KaHTOWjcazOe5ya/ckfGBBGJY5MoStqz/aUZrsKmW2FTlWE3xX3kywlgT/sEATEwYtjIMCLYdwZ6SW+4NLmShNQcmEb0lwZTUbCcGWI2v49QP3HdVnG/WczUrkRKdySeo9hrdlH45lFypgiPyFfwI12vQzDsxyZwA25xGI+S+Y22hwMCWg7tBssVsz//xAAbEQACAgMBAAAAAAAAAAAAAAAAAQIQESExQf/aAAgBAgEBPwBD6e0hyeSPb3sTeblpkd1gl0h1jP/EAB0RAAIDAQEAAwAAAAAAAAAAAAECAAMRITESQXH/2gAIAQMBAT8AqKg56TEpGMcH5HpQrpGcjKRKQPd7FUYI2heGOemV9cTBzJbgQwwboyU/IKD9y4EiYAMMVAvkTyPGUGf/2Q==" class="jciay5ix tvf2evcx oq44ahr5 lb5m6g5c fsmudgz7" style="height: 100%;"></div><div class="lhggkp7q jnl3jror p357zi0d gndfcl4n ac2vgrno ln8gz9je ppled2lx"><img alt="זו" src="blob:https://web.whatsapp.com/7c8ef641-ca6e-4979-b620-cd5f71c295a0" class="jciay5ix tvf2evcx oq44ahr5 lb5m6g5c" style="height: 100%;"></div></div></div><div class="cm280p3y czh1irh3 esbfogcw jfqm35v0 bxcbqipq mhcwslh8"><div class="_21Ahp"><span data-testid="image-caption" dir="rtl" aria-label="" class="_11JPr selectable-text copyable-text"><span class="f804f6gw ln8gz9je">זו</span></span><span class=""><span class="o38k74y6 i86elurf neme6l2y kojwoqec bbl9m3t3 i5tg98hk jfqm35v0 przvwfww bdbt56hn cr2cog7z" aria-hidden="true"><span class="tvf2evcx oq44ahr5 qg8w82as"></span><span class="tvf2evcx oq44ahr5">10:55</span></span></span></div></div><div class="lrw9n60e lhggkp7q fz4q5utg b9fczbqn"><div class="gq1t1y46 o38k74y6 e4p1bexh cr2cog7z le5p0ye3 p357zi0d gndfcl4n" data-testid="msg-meta" role="button"><span class="l7jjieqr fewfhwl7" dir="auto">10:55</span><div class="do8e0lj9 l7jjieqr k6y3xtnu"><span data-testid="msg-dblcheck" aria-label=" Read " data-icon="msg-dblcheck" class="S7n_s"><svg viewBox="0 0 16 11" height="11" width="16" preserveAspectRatio="xMidYMid meet" class="" fill="none"><path d="M11.0714 0.652832C10.991 0.585124 10.8894 0.55127 10.7667 0.55127C10.6186 0.55127 10.4916 0.610514 10.3858 0.729004L4.19688 8.36523L1.79112 6.09277C1.7488 6.04622 1.69802 6.01025 1.63877 5.98486C1.57953 5.95947 1.51817 5.94678 1.45469 5.94678C1.32351 5.94678 1.20925 5.99544 1.11192 6.09277L0.800883 6.40381C0.707784 6.49268 0.661235 6.60482 0.661235 6.74023C0.661235 6.87565 0.707784 6.98991 0.800883 7.08301L3.79698 10.0791C3.94509 10.2145 4.11224 10.2822 4.29844 10.2822C4.40424 10.2822 4.5058 10.259 4.60313 10.2124C4.70046 10.1659 4.78086 10.1003 4.84434 10.0156L11.4903 1.59863C11.5623 1.5013 11.5982 1.40186 11.5982 1.30029C11.5982 1.14372 11.5348 1.01888 11.4078 0.925781L11.0714 0.652832ZM8.6212 8.32715C8.43077 8.20866 8.2488 8.09017 8.0753 7.97168C7.99489 7.89128 7.8891 7.85107 7.75791 7.85107C7.6098 7.85107 7.4892 7.90397 7.3961 8.00977L7.10411 8.33984C7.01947 8.43717 6.97715 8.54508 6.97715 8.66357C6.97715 8.79476 7.0237 8.90902 7.1168 9.00635L8.1959 10.0791C8.33132 10.2145 8.49636 10.2822 8.69102 10.2822C8.79681 10.2822 8.89838 10.259 8.99571 10.2124C9.09304 10.1659 9.17556 10.1003 9.24327 10.0156L15.8639 1.62402C15.9358 1.53939 15.9718 1.43994 15.9718 1.32568C15.9718 1.1818 15.9125 1.05697 15.794 0.951172L15.4386 0.678223C15.3582 0.610514 15.2587 0.57666 15.1402 0.57666C14.9964 0.57666 14.8715 0.635905 14.7657 0.754395L8.6212 8.32715Z" fill="currentColor"></path></svg></span></div></div></div></div></div><span></span><div class="_1OdBf"></div></div><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd p357zi0d dnb887gk gjuq5ydh i2cterl7 kcgo1i74 sap93d0t gndfcl4n FxqSn"><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd dnb887gk gjuq5ydh i2cterl7 rqm6ogl5 i5tg98hk folpon7g przvwfww snweb893"><div></div></div><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd dnb887gk gjuq5ydh i2cterl7 rqm6ogl5 i5tg98hk folpon7g przvwfww snweb893"><div role="button" tabindex="0" aria-label="Forward media" class="_1Gsa4 p357zi0d gndfcl4n ac2vgrno cxkis295 rqm6ogl5 i5tg98hk f9ovudaz przvwfww gx1rr48f f8jlpxt4 hnx8ox4h k17s6i4e ofejerhi ilbp7ui4 g9p5wyxn i0tg5vk9 aoogvgrq o2zu3hjb a27i2aag rtx6r8la e3b81npk oa9ii99z fb82vjfj"><span data-testid="forward-chat" data-icon="forward-chat" class="r83rrh3w"><svg viewBox="0 0 25 25" height="25" width="25" preserveAspectRatio="xMidYMid meet" class="" version="1.1" x="0px" y="0px" enable-background="new 0 0 25 25" xml:space="preserve"><path fill-rule="evenodd" clip-rule="evenodd" fill="currentColor" d="M14.248,6.973c0-0.614,0.741-0.921,1.174-0.488l5.131,5.136 c0.269,0.269,0.269,0.704,0,0.973l-5.131,5.136c-0.433,0.433-1.174,0.126-1.174-0.488v-2.319c-4.326,0-7.495,1.235-9.85,3.914 c-0.209,0.237-0.596,0.036-0.511-0.268c1.215-4.391,4.181-8.492,10.361-9.376V6.973z"></path></svg></span></div></div></div></div></div></div></div>`);
      const rowElements = dom.window.document.querySelectorAll('div[role="row"]');
  
      const result = parseHTMLRows(rowElements);
      expect(result).toHaveProperty("messageCount");
      expect(result).toHaveProperty("messageText");
      expect(result.messageText).toBe('[10:55, 01/08/2023] Ido Frizler shared a photo with this caption: זו<br>');
      expect(result.messageCount).toBe(1);  
    });
  
    // multiple photos sent in a row
    it("multiple photos sent in a row", () => {
      const dom = new JSDOM(``);
      const rowElements = dom.window.document.querySelectorAll('div[role="row"]');
  
      const result = parseHTMLRows(rowElements);
      expect(result).toHaveProperty("messageCount");
      expect(result).toHaveProperty("messageText");
      expect(result.messageText).toBe('[14:16, 01/08/2023] Dekel Meidan shared X photos<br>');
      expect(result.messageCount).toBe(1);  
    });
  
    // photo from known sender
    it("photo from known sender", () => {
        const dom = new JSDOM(`<div class="" role="row"><div tabindex="-1" class="CzM4m" data-id="false_972505721286-1352570493@g.us_C77B27E0149E81E6BAD8A6C8E597B4BE_972502141651@c.us" data-testid="conv-msg-false_972505721286-1352570493@g.us_C77B27E0149E81E6BAD8A6C8E597B4BE_972502141651@c.us"><div class="_3EyT- message-in focusable-list-item _1AOLJ _1jHIY"><span></span><div data-testid="msg-container" class="UzMP7 _27hEJ _3m5cz"><span data-testid="tail-in" data-icon="tail-in" class="p0s8B"><svg viewBox="0 0 8 13" height="13" width="8" preserveAspectRatio="xMidYMid meet" class="" version="1.1" x="0px" y="0px" enable-background="new 0 0 8 13" xml:space="preserve"><path opacity="0.13" fill="#0000000" d="M1.533,3.568L8,12.193V1H2.812 C1.042,1,0.474,2.156,1.533,3.568z"></path><path fill="currentColor" d="M1.533,2.568L8,11.193V0L2.812,0C1.042,0,0.474,1.156,1.533,2.568z"></path></svg></span><div data-testid="group-chat-profile-picture" tabindex="0" role="button" aria-label="Open chat details for Liat Hayun" class="lhggkp7q g9p5wyxn i0tg5vk9 aoogvgrq o2zu3hjb hj486dpu a2hqsskl stnyektq" style="cursor: pointer;"><img src="https://pps.whatsapp.net/v/t61.24694-24/56153885_2370748213238981_4616902531086286848_n.jpg?stp=dst-jpg_s96x96&amp;ccb=11-4&amp;oh=01_AdQHWdZ3QyNlaVKPgq-DBhn3VNcP5MfgJ9fMsqcO0Inc2w&amp;oe=64E25FBD" alt="" draggable="false" class="csshhazd g0rxnol2 f804f6gw ln8gz9je ppled2lx gfz4du6o r7fjleex g9p5wyxn i0tg5vk9 aoogvgrq o2zu3hjb bs7a17vp _11JPr" tabindex="-1" style="visibility: visible;"></div><div class="_1BOF7 _2AOIt"><div class="cm280p3y ktbp76dp ocd2b0bc folpon7g aa0kojfi snweb893 g0rxnol2 jnl3jror"><div><div class="bxcbqipq mhcwslh8 ocd2b0bc jfqm35v0"><div class="_3IzYj color-2 _6rIWC p357zi0d" role=""><span data-testid="author" dir="auto" aria-label="" class="_3FuDI ajgl1lbb edeob0r2 _11JPr">Liat Hayun</span></div></div><div role="button" tabindex="0" data-testid="image-thumb" aria-label="Open Picture" class="gndfcl4n l8fojup5 paxyh2gw sfeitywo cqsf3vkf p357zi0d ac2vgrno laorhtua gfz4du6o r7fjleex g0rxnol2" style="width: 330px; height: 248.325px;"><div class="g0rxnol2 ln8gz9je ppled2lx" data-testid="media-url-provider"><div class="lhggkp7q jnl3jror p357zi0d gndfcl4n ac2vgrno ln8gz9je ppled2lx"><img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wCEABsbGxscGx4hIR4qLSgtKj04MzM4PV1CR0JHQl2NWGdYWGdYjX2Xe3N7l33gsJycsOD/2c7Z//////////////8BGxsbGxwbHiEhHiotKC0qPTgzMzg9XUJHQkdCXY1YZ1hYZ1iNfZd7c3uXfeCwnJyw4P/Zztn////////////////CABEIADAAPwMBIgACEQEDEQH/xAAvAAADAQEBAAAAAAAAAAAAAAACAwQFAQABAQEBAQEAAAAAAAAAAAAAAAIAAQME/9oADAMBAAIQAxAAAABzRf4+pyipi3slhaCUrUL8UtGzJCpW1Rh9raDIGzrJ6bUrqQ4jS5XhLnO//8QAJRAAAgICAQQCAgMAAAAAAAAAAQIAAxESIRMiMUEUUQQQIzJx/9oACAEBAAE/ALQdxgkTRi2xJAEOmsfAZwfqKBgf5O3BM1dSCzDBhXPgy+zAQzqcABcy19T4jEWPznIEqvZrNIxJU7AAxLd8+9YbG6uxOFE+VV7MX8mnH9hOvWfBBny06pGpiWVZJGMzqIRywgNajggTFW23GYKQQOTBSPudXTsxz6MW5g7Mw7vUFYK7b931Arr4afyH3Arj3FZSAAef1YCRkRbV43Xke4LaySYHVidZmBpQnJaETXiMkFAgQL4ExMT/xAAgEQACAQIHAQAAAAAAAAAAAAABAgADERATISIxQUIS/9oACAECAQE/AAi7do7goC4ItMlVG4a3hpKHI+eBMqmDyYKQ1goge4aQPuMLNEYRmW3V8P/EAB4RAAICAQUBAAAAAAAAAAAAAAABAhExEBITIWFS/9oACAEDAQE/AHLo5ayhT3F+2XIvA2/kvwXaKZc3SeNP/9k=" class="jciay5ix tvf2evcx oq44ahr5 lb5m6g5c fsmudgz7" style="width: 100%;"></div><div class="lhggkp7q jnl3jror p357zi0d gndfcl4n ac2vgrno ln8gz9je ppled2lx"><img src="blob:https://web.whatsapp.com/d55cac92-7c5c-428c-9a99-80bf733d1e96" class="jciay5ix tvf2evcx oq44ahr5 lb5m6g5c osz0hll6 nq7eualt em5jvqoa a21kwdn3" style="width: 100%;"></div></div><div class="lhggkp7q jxacihee tkdu00h0 b9fczbqn ln8gz9je he7yjufn e1lnay39"></div></div><div class="dpkuihx7 lhggkp7q j2mzdvlq b9fczbqn"><div class="pp8r7oc8 o38k74y6 e4p1bexh cr2cog7z le5p0ye3 p357zi0d gndfcl4n" data-testid="msg-meta"><span class="l7jjieqr fewfhwl7" dir="auto">01:08</span></div></div></div></div><span></span><div class="_1OdBf"></div></div><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd p357zi0d dnb887gk gjuq5ydh i2cterl7 fhf7t426 sap93d0t gndfcl4n FxqSn"><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd dnb887gk gjuq5ydh i2cterl7 rqm6ogl5 i5tg98hk folpon7g przvwfww snweb893"><div role="button" tabindex="0" aria-label="Forward media" class="_1Gsa4 p357zi0d gndfcl4n ac2vgrno cxkis295 rqm6ogl5 i5tg98hk f9ovudaz przvwfww gx1rr48f f8jlpxt4 hnx8ox4h k17s6i4e ofejerhi ilbp7ui4 g9p5wyxn i0tg5vk9 aoogvgrq o2zu3hjb a27i2aag rtx6r8la e3b81npk oa9ii99z fb82vjfj"><span data-testid="forward-chat" data-icon="forward-chat" class="r83rrh3w"><svg viewBox="0 0 25 25" height="25" width="25" preserveAspectRatio="xMidYMid meet" class="" version="1.1" x="0px" y="0px" enable-background="new 0 0 25 25" xml:space="preserve"><path fill-rule="evenodd" clip-rule="evenodd" fill="currentColor" d="M14.248,6.973c0-0.614,0.741-0.921,1.174-0.488l5.131,5.136 c0.269,0.269,0.269,0.704,0,0.973l-5.131,5.136c-0.433,0.433-1.174,0.126-1.174-0.488v-2.319c-4.326,0-7.495,1.235-9.85,3.914 c-0.209,0.237-0.596,0.036-0.511-0.268c1.215-4.391,4.181-8.492,10.361-9.376V6.973z"></path></svg></span></div></div><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd dnb887gk gjuq5ydh i2cterl7 rqm6ogl5 i5tg98hk folpon7g przvwfww snweb893"><div></div></div></div></div></div></div></div>`);
        const rowElements = dom.window.document.querySelectorAll('div[role="row"]');
    
        const result = parseHTMLRows(rowElements);
        expect(result).toHaveProperty("messageCount");
        expect(result).toHaveProperty("messageText");
        expect(result.messageText).toBe('[01:08] Liat Hayun shared a photo<br>');
        expect(result.messageCount).toBe(1);  
      });

    // photo not yet downloaded

    // video was shared

    // video not yet downloaded

    // voice message was shared

    // poll was shared

    // message with only emoji
});

describe("Quoted messages", () => {

    // quoting another message
    it("should extract both quoted message and reply", () => {
        const dom = new JSDOM(`<div class="" role="row"><div tabindex="-1" class="CzM4m" data-id="true_972505721286-1352570493@g.us_6341164CD5007FDD03_972505721286@c.us" data-testid="conv-msg-true_972505721286-1352570493@g.us_6341164CD5007FDD03_972505721286@c.us"><div class="message-out focusable-list-item _1AOLJ _1jHIY"><span></span><div data-testid="msg-container" class="UzMP7 _1uv-a"><div class="_1BOF7 _2AOIt"><span aria-label="You:"></span><div><div class="cm280p3y to2l77zo n1yiu2zv ft2m32mm oq31bsqd e1yunedv"><div class="copyable-text" data-pre-plain-text="[23:04, 12/08/2023] Ido Frizler: "><div class="_1hl2r"><div data-testid="quoted-message" class="HLjg0"><div class="_1EbXp" role="button" aria-label="Quoted Message" tabindex="0"><span class="bg-color-1 _1Jh1l"></span><div class="yKTUI _3pMOs"><div class="yKTUI _1JeGx"><div class="_3IzYj color-1 p357zi0d" role=""><span data-testid="author" dir="auto" aria-label="" class="_3FuDI _11JPr">Alon Navon</span></div><div class="_37DQv" dir="rtl" role="button"><span dir="auto" aria-label="" class="quoted-mention _11JPr">להגיד על מישהו שיש לו מלא rizz?</span></div></div></div></div></div></div><div class="_21Ahp"><span dir="rtl" aria-label="" class="_11JPr selectable-text copyable-text"><span class="f804f6gw ln8gz9je">לא</span></span><span class=""><span class="o38k74y6 i86elurf neme6l2y kojwoqec bbl9m3t3 i5tg98hk jfqm35v0 przvwfww bdbt56hn cr2cog7z" aria-hidden="true"><span class="tvf2evcx oq44ahr5 qg8w82as"></span><span class="tvf2evcx oq44ahr5">23:04</span></span></span></div></div><div class="g0rxnol2 g2bpp9au ivui8b66 aja0i6dq jnwc1y2a bn7x0pqn qnz2jpws"><div class="gq1t1y46 o38k74y6 e4p1bexh cr2cog7z le5p0ye3 p357zi0d gndfcl4n" data-testid="msg-meta" role="button"><span class="l7jjieqr fewfhwl7" dir="auto">23:04</span><div class="do8e0lj9 l7jjieqr k6y3xtnu"><span data-testid="msg-dblcheck" aria-label=" Read " data-icon="msg-dblcheck" class="S7n_s"><svg viewBox="0 0 16 11" height="11" width="16" preserveAspectRatio="xMidYMid meet" class="" fill="none"><path d="M11.0714 0.652832C10.991 0.585124 10.8894 0.55127 10.7667 0.55127C10.6186 0.55127 10.4916 0.610514 10.3858 0.729004L4.19688 8.36523L1.79112 6.09277C1.7488 6.04622 1.69802 6.01025 1.63877 5.98486C1.57953 5.95947 1.51817 5.94678 1.45469 5.94678C1.32351 5.94678 1.20925 5.99544 1.11192 6.09277L0.800883 6.40381C0.707784 6.49268 0.661235 6.60482 0.661235 6.74023C0.661235 6.87565 0.707784 6.98991 0.800883 7.08301L3.79698 10.0791C3.94509 10.2145 4.11224 10.2822 4.29844 10.2822C4.40424 10.2822 4.5058 10.259 4.60313 10.2124C4.70046 10.1659 4.78086 10.1003 4.84434 10.0156L11.4903 1.59863C11.5623 1.5013 11.5982 1.40186 11.5982 1.30029C11.5982 1.14372 11.5348 1.01888 11.4078 0.925781L11.0714 0.652832ZM8.6212 8.32715C8.43077 8.20866 8.2488 8.09017 8.0753 7.97168C7.99489 7.89128 7.8891 7.85107 7.75791 7.85107C7.6098 7.85107 7.4892 7.90397 7.3961 8.00977L7.10411 8.33984C7.01947 8.43717 6.97715 8.54508 6.97715 8.66357C6.97715 8.79476 7.0237 8.90902 7.1168 9.00635L8.1959 10.0791C8.33132 10.2145 8.49636 10.2822 8.69102 10.2822C8.79681 10.2822 8.89838 10.259 8.99571 10.2124C9.09304 10.1659 9.17556 10.1003 9.24327 10.0156L15.8639 1.62402C15.9358 1.53939 15.9718 1.43994 15.9718 1.32568C15.9718 1.1818 15.9125 1.05697 15.794 0.951172L15.4386 0.678223C15.3582 0.610514 15.2587 0.57666 15.1402 0.57666C14.9964 0.57666 14.8715 0.635905 14.7657 0.754395L8.6212 8.32715Z" fill="currentColor"></path></svg></span></div></div></div></div></div><span></span><div class="_1OdBf"></div></div><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd p357zi0d dnb887gk gjuq5ydh i2cterl7 kcgo1i74 sap93d0t gndfcl4n FxqSn"><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd dnb887gk gjuq5ydh i2cterl7 rqm6ogl5 i5tg98hk folpon7g przvwfww snweb893"><div></div></div></div></div></div></div></div>`);
        const rowElements = dom.window.document.querySelectorAll('div[role="row"]');
    
        const result = parseHTMLRows(rowElements);
        expect(result).toHaveProperty("messageCount");
        expect(result).toHaveProperty("messageText");
        expect(result.messageText).toBe('[23:04, 12/08/2023] Ido Frizler replied "לא" to Alon Navon\'s message "להגיד על מישהו שיש לו מלא rizz?"<br>');
        expect(result.messageCount).toBe(1);  
      });

    // quote of yourself in a private chat
    it("quote of yourself in a private chat", () => {
        const dom = new JSDOM(`<div class="" role="row"><div tabindex="-1" class="CzM4m" data-id="false_972505301337@c.us_3EB0B340CEFC1813E90C76" data-testid="conv-msg-false_972505301337@c.us_3EB0B340CEFC1813E90C76"><div class="_3sxvM message-in focusable-list-item _1AOLJ _2UtSC _1jHIY"><span></span><div data-testid="msg-container" class="UzMP7 _1uv-a"><div class="_1BOF7 _2AOIt"><div><div class="cm280p3y to2l77zo n1yiu2zv c6f98ldp ooty25bp oq31bsqd"><div class="copyable-text" data-pre-plain-text="[22:28, 13/08/2023] Shimi Gersner: "><div class="_1hl2r"><div data-testid="quoted-message" class="HLjg0"><div class="_1EbXp" role="button" aria-label="Quoted Message" tabindex="0"><span class="bg-color-2 _1Jh1l"></span><div class="_3pMOs"><div class="_1JeGx"><div class="_3IzYj color-2" role=""><span dir="auto" aria-label="" class="_11JPr">You</span></div><div class="_37DQv" dir="rtl" role="button"><span dir="auto" aria-label="" class="quoted-mention _11JPr">וואי תודה שאמרת לי. אני מתחיל לחשוב שהוא עושה לי שוב את הקטע הזה</span></div></div></div></div></div></div><div class="_21Ahp"><span dir="rtl" aria-label="" class="_11JPr selectable-text copyable-text"><span class="f804f6gw ln8gz9je">עשה את זה אז?</span></span><span class=""><span class="o38k74y6 i86elurf neme6l2y kojwoqec bbl9m3t3 i5tg98hk jfqm35v0 przvwfww bdbt56hn cr2cog7z" aria-hidden="true"><span class="tvf2evcx oq44ahr5">22:28</span></span></span></div></div><div class="g0rxnol2 g2bpp9au ivui8b66 aja0i6dq jnwc1y2a bn7x0pqn qnz2jpws"><div class="gq1t1y46 o38k74y6 e4p1bexh cr2cog7z le5p0ye3 p357zi0d gndfcl4n" data-testid="msg-meta"><span class="l7jjieqr fewfhwl7" dir="auto">22:28</span></div></div></div></div><span></span><div class="_1OdBf"></div></div><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd p357zi0d dnb887gk gjuq5ydh i2cterl7 fhf7t426 sap93d0t gndfcl4n FxqSn"><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd dnb887gk gjuq5ydh i2cterl7 rqm6ogl5 i5tg98hk folpon7g przvwfww snweb893"><div></div></div></div></div></div></div></div>`);
        const rowElements = dom.window.document.querySelectorAll('div[role="row"]');

        const result = parseHTMLRows(rowElements);
        expect(result).toHaveProperty("messageCount");
        expect(result).toHaveProperty("messageText");
        expect(result.messageText).toBe('[22:28, 13/08/2023] Shimi Gersner replied "עשה את זה אז?" to your message "וואי תודה שאמרת לי. אני מתחיל לחשוב שהוא עושה לי שוב את הקטע הזה"<br>');
        expect(result.messageCount).toBe(1);  
    });

    // quoting another message from unknown sender
    it("quoting another message from unknown sender", () => {
        const dom = new JSDOM(`<div class="" role="row"><div tabindex="-1" class="CzM4m" data-id="false_120363043304575601@g.us_3ACB7836C748E60CCCA9_972523912225@c.us" data-testid="conv-msg-false_120363043304575601@g.us_3ACB7836C748E60CCCA9_972523912225@c.us"><div class="message-in focusable-list-item _1AOLJ _1jHIY"><span></span><div data-testid="msg-container" class="UzMP7 _1uv-a _3m5cz"><span data-testid="tail-in" data-icon="tail-in" class="p0s8B"><svg viewBox="0 0 8 13" height="13" width="8" preserveAspectRatio="xMidYMid meet" class="" version="1.1" x="0px" y="0px" enable-background="new 0 0 8 13" xml:space="preserve"><path opacity="0.13" fill="#0000000" d="M1.533,3.568L8,12.193V1H2.812 C1.042,1,0.474,2.156,1.533,3.568z"></path><path fill="currentColor" d="M1.533,2.568L8,11.193V0L2.812,0C1.042,0,0.474,1.156,1.533,2.568z"></path></svg></span><div data-testid="group-chat-profile-picture" tabindex="0" role="button" aria-label="Open chat details for יעל אמא של רום (אלה)" class="lhggkp7q g9p5wyxn i0tg5vk9 aoogvgrq o2zu3hjb hj486dpu a2hqsskl stnyektq" style="cursor: pointer;"><img src="https://pps.whatsapp.net/v/t61.24694-24/366637312_2566798603486351_3029926176368760677_n.jpg?stp=dst-jpg_s96x96&amp;ccb=11-4&amp;oh=01_AdRMAjjYkoJXnzNgL6zrP85S_4v1gkZO_BH95h5eflOmKg&amp;oe=64E6CA36" alt="" draggable="false" class="csshhazd g0rxnol2 f804f6gw ln8gz9je ppled2lx gfz4du6o r7fjleex g9p5wyxn i0tg5vk9 aoogvgrq o2zu3hjb bs7a17vp _11JPr" tabindex="-1" style="visibility: visible;"></div><div class="_1BOF7 _2AOIt"><div><div class="cm280p3y to2l77zo n1yiu2zv ft2m32mm oq31bsqd e1yunedv"><div class="_3IzYj color-8 _6rIWC p357zi0d" role=""><span data-testid="author" dir="auto" aria-label="" class="_3FuDI ajgl1lbb edeob0r2 _11JPr">יעל אמא של רום (אלה)</span></div><div class="_1DETJ copyable-text" data-pre-plain-text="[19:06, 03/08/2023] יעל אמא של רום (אלה): "><div class="_1hl2r"><div data-testid="quoted-message" class="HLjg0"><div class="_3_Q0Q _1EbXp" role="button" aria-label="Quoted Message" tabindex="0"><span class="bg-color-12 _1Jh1l"></span><div class="yKTUI _3pMOs"><div class="yKTUI _1JeGx"><div class="_3IzYj color-12 p357zi0d" role=""><span data-testid="author" dir="auto" aria-label="Maybe Noa Benaroya" class="_2ne0X ggj6brxn gfz4du6o r7fjleex g0rxnol2 lhj4utae le5p0ye3 _11JPr">Noa Benaroya</span><span class="WJuYU" testid="author">+972 52-830-5580</span></div><div class="_37DQv" dir="rtl" role="button"><span dir="auto" aria-label="" class="quoted-mention _11JPr">ממקורות יודעי דבר, אין עדיין שיבוצים כולם רשומים פיקטיבית לא1</span></div></div></div></div></div></div><div class="_21Ahp"><span dir="rtl" aria-label="" class="_11JPr selectable-text copyable-text"><span class="f804f6gw ln8gz9je">זה מה שחשבתי שזה.</span></span><span class=""><span class="o38k74y6 i86elurf neme6l2y kojwoqec bbl9m3t3 i5tg98hk jfqm35v0 przvwfww bdbt56hn cr2cog7z" aria-hidden="true"><span class="tvf2evcx oq44ahr5">19:06</span></span></span></div></div><div class="g0rxnol2 g2bpp9au ivui8b66 aja0i6dq jnwc1y2a bn7x0pqn qnz2jpws"><div class="gq1t1y46 o38k74y6 e4p1bexh cr2cog7z le5p0ye3 p357zi0d gndfcl4n" data-testid="msg-meta"><span class="l7jjieqr fewfhwl7" dir="auto">19:06</span></div></div></div></div><span><div class="_1bGUW _2T2Kt" style="opacity: 1;"><div data-testid="icon-down-context" data-js-context-icon="true" class="_3u9t-" tabindex="0" aria-label="Context Menu" role="button" style="transform: translateX(0%);"><span data-testid="down-context" data-icon="down-context" class=""><svg viewBox="0 0 18 18" height="18" width="18" preserveAspectRatio="xMidYMid meet" class="" version="1.1" x="0px" y="0px" enable-background="new 0 0 18 18" xml:space="preserve"><path fill="currentColor" d="M3.3,4.6L9,10.3l5.7-5.7l1.6,1.6L9,13.4L1.7,6.2L3.3,4.6z"></path></svg></span></div></div></span><div class="_1OdBf"></div></div><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd p357zi0d dnb887gk gjuq5ydh i2cterl7 fhf7t426 sap93d0t gndfcl4n FxqSn"><div class="tvf2evcx m0h2a7mj lb5m6g5c j7l1k36l ktfrpxia nu7pwgvd dnb887gk gjuq5ydh i2cterl7 rqm6ogl5 i5tg98hk folpon7g przvwfww snweb893"><div><div role="button" tabindex="0" data-testid="reaction-entry-point" aria-label="React" class="p357zi0d gndfcl4n ac2vgrno cxkis295 rqm6ogl5 i5tg98hk f9ovudaz przvwfww gx1rr48f f8jlpxt4 hnx8ox4h k17s6i4e ofejerhi ilbp7ui4 g9p5wyxn i0tg5vk9 aoogvgrq o2zu3hjb a27i2aag rtx6r8la e3b81npk oa9ii99z fb82vjfj"><span data-testid="react" data-icon="react" class="qcuzhokb"><svg viewBox="0 0 15 15" width="15" preserveAspectRatio="xMidYMid meet" class="" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M0 7.5C0 11.6305 3.36946 15 7.5 15C11.6527 15 15 11.6305 15 7.5C15 3.36946 11.6305 0 7.5 0C3.36946 0 0 3.36946 0 7.5ZM10.995 8.69333C11.1128 8.67863 11.2219 8.66503 11.3211 8.65309C11.61 8.63028 11.8076 8.91918 11.6784 9.13965C10.8573 10.6374 9.29116 11.793 7.50455 11.793C5.71794 11.793 4.15181 10.6602 3.33072 9.16246C3.18628 8.91918 3.37634 8.63028 3.66524 8.65309C3.79123 8.66749 3.93521 8.68511 4.09426 8.70457C4.94292 8.80842 6.22074 8.96479 7.48174 8.96479C8.81855 8.96479 10.1378 8.80025 10.995 8.69333ZM5.41405 7.37207C6.05761 7.37207 6.60923 6.72851 6.60923 6.02978C6.60923 5.30348 6.05761 4.6875 5.41405 4.6875C4.77048 4.6875 4.21886 5.33106 4.21886 6.02978C4.20967 6.75609 4.77048 7.37207 5.41405 7.37207ZM10.7807 6.05619C10.7807 6.74114 10.24 7.37201 9.60912 7.37201C8.97825 7.37201 8.4375 6.76818 8.4375 6.05619C8.4375 5.37124 8.97825 4.74037 9.60912 4.74037C10.24 4.74037 10.7807 5.34421 10.7807 6.05619Z" fill="currentColor"></path></svg></span></div></div></div></div></div></div></div></div>`);
        const rowElements = dom.window.document.querySelectorAll('div[role="row"]');
    
        const result = parseHTMLRows(rowElements);
        expect(result).toHaveProperty("messageCount");
        expect(result).toHaveProperty("messageText");
        expect(result.messageText).toBe('[19:06, 03/08/2023] יעל אמא של רום (אלה) replied \"זה מה שחשבתי שזה.\" to Noa Benaroya\'s message \"ממקורות יודעי דבר, אין עדיין שיבוצים כולם רשומים פיקטיבית לא1"<br>');
        expect(result.messageCount).toBe(1);  
      });

  });